# üöÄ Guia Completo: Configurando PostgreSQL do Vercel com Django

**Para iniciantes e desenvolvedores que querem uma configura√ß√£o 100% funcional**

Este guia te levar√° passo a passo para configurar um banco de dados PostgreSQL no Vercel e conect√°-lo ao seu projeto Django. Cada etapa √© explicada em detalhes com exemplos pr√°ticos.

---

## üìã Pr√©-requisitos

Antes de come√ßar, certifique-se de ter:

- ‚úÖ Projeto Django funcionando localmente
- ‚úÖ Conta no GitHub com seu c√≥digo
- ‚úÖ Conta no Vercel (gratuita)
- ‚úÖ Python e pip instalados

---

## üèóÔ∏è Parte 1: Preparando o Projeto Django

### 1.1 Instale as Depend√™ncias Necess√°rias

No terminal, dentro da pasta do seu projeto Django:

```bash
pip install psycopg2-binary dj-database-url python-decouple
```

### 1.2 Atualize o requirements.txt

Crie ou atualize o arquivo `requirements.txt` na raiz do projeto:

```txt
Django>=4.0
psycopg2-binary
dj-database-url
python-decouple
gunicorn
whitenoise
```

### 1.3 Configure o settings.py

Substitua as configura√ß√µes do seu `settings.py`:

```python
import os
import dj_database_url
from decouple import config

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = config('SECRET_KEY', default='sua-chave-secreta-local-aqui')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = config('DEBUG', default=True, cast=bool)

ALLOWED_HOSTS = ['localhost', '127.0.0.1', '.vercel.app']

# Application definition
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # Seus apps aqui
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',  # Para arquivos est√°ticos
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'seu_projeto.urls'  # Substitua pelo nome do seu projeto

# Database Configuration
# Configura√ß√£o para produ√ß√£o (Vercel) e desenvolvimento local
if config('DATABASE_URL', default=None):
    # Produ√ß√£o - usando PostgreSQL do Vercel
    DATABASES = {
        'default': dj_database_url.config(
            default=config('DATABASE_URL'),
            conn_max_age=600,
            conn_health_checks=True,
        )
    }
else:
    # Desenvolvimento local - usando SQLite
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': BASE_DIR / 'db.sqlite3',
        }
    }

# Static files (CSS, JavaScript, Images)
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

# Configura√ß√µes de seguran√ßa para produ√ß√£o
if not DEBUG:
    SECURE_SSL_REDIRECT = True
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
    SECURE_HSTS_SECONDS = 31536000
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
```

### 1.4 Crie o arquivo .env (para desenvolvimento local)

Na raiz do projeto, crie um arquivo `.env`:

```env
SECRET_KEY=sua-chave-secreta-muito-complexa-aqui
DEBUG=True
```

### 1.5 Crie o arquivo vercel.json

Na raiz do projeto, crie `vercel.json`:

```json
{
  "version": 2,
  "builds": [
    {
      "src": "seu_projeto/wsgi.py",
      "use": "@vercel/python",
      "config": { "maxLambdaSize": "15mb", "runtime": "python3.9" }
    },
    {
      "src": "build_files.sh",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "staticfiles_build"
      }
    }
  ],
  "routes": [
    {
      "src": "/static/(.*)",
      "dest": "/static/$1"
    },
    {
      "src": "/(.*)",
      "dest": "seu_projeto/wsgi.py"
    }
  ]
}
```

**‚ö†Ô∏è Importante**: Substitua `seu_projeto` pelo nome real da sua pasta de projeto!

### 1.6 Crie o arquivo build_files.sh

Na raiz do projeto:

```bash
#!/bin/bash

# Instala as depend√™ncias
pip install -r requirements.txt

# Coleta arquivos est√°ticos
python manage.py collectstatic --noinput

# Executa as migra√ß√µes
python manage.py migrate --noinput
```

Torne o arquivo execut√°vel:

```bash
chmod +x build_files.sh
```

---

## üåê Parte 2: Configurando no Vercel

### 2.1 Fazendo Deploy Inicial

1. **Acesse**: [vercel.com](https://vercel.com)
2. **Login**: Use sua conta GitHub
3. **Import Project**: Clique em "New Project"
4. **Selecione seu reposit√≥rio**: Escolha o repo do seu Django
5. **Configure o projeto**:
   - **Framework Preset**: Other
   - **Root Directory**: `./` (raiz)
   - **Build Command**: `./build_files.sh`
   - **Install Command**: `pip install -r requirements.txt`
6. **Deploy**: Clique em "Deploy"

### 2.2 Criando o Banco PostgreSQL

Ap√≥s o deploy inicial:

1. **Acesse seu projeto** no dashboard do Vercel
2. **V√° para Storage**: Clique na aba "Storage"
3. **Create Database**: Clique em "Create"
4. **Selecione PostgreSQL**: Escolha "Postgres"
5. **Configure**:
   - **Database Name**: `meu-projeto-db` (escolha um nome)
   - **Region**: Escolha a regi√£o mais pr√≥xima (ex: S√£o Paulo)
6. **Create**: Confirme a cria√ß√£o

### 2.3 Obtendo as Credenciais

Ap√≥s criar o banco:

1. **Clique no banco criado** na lista
2. **V√° para .env.local**: Encontre a se√ß√£o de credenciais
3. **Copie a DATABASE_URL**: Algo como:
   ```
   postgresql://usuario:senha@host:5432/database
   ```

### 2.4 Configurando Vari√°veis de Ambiente

1. **Settings**: V√° para "Settings" do seu projeto
2. **Environment Variables**: Clique na se√ß√£o
3. **Adicione as vari√°veis**:

   | Nome | Valor | Ambientes |
   |------|-------|-----------|
   | `DATABASE_URL` | Cole a URL copiada | Production, Preview |
   | `SECRET_KEY` | Gere uma chave secreta forte | Production, Preview |
   | `DEBUG` | `False` | Production, Preview |

**üîê Como gerar SECRET_KEY**:
```python
# Execute no terminal Python:
from django.core.management.utils import get_random_secret_key
print(get_random_secret_key())
```

---

## üîÑ Parte 3: Executando Migra√ß√µes

### 3.1 Op√ß√£o 1: Via Build Script (Recomendado)

As migra√ß√µes j√° est√£o configuradas no `build_files.sh`. A cada deploy, elas executar√£o automaticamente.

### 3.2 Op√ß√£o 2: Via Vercel CLI (Manual)

Instale a CLI do Vercel:

```bash
npm install -g vercel
```

Execute migra√ß√µes:

```bash
vercel login
vercel env pull .env.production
python manage.py migrate --settings=seu_projeto.settings
```

### 3.3 Op√ß√£o 3: Fun√ß√£o Serverless para Migra√ß√µes

Crie `api/migrate.py`:

```python
from django.core.management import execute_from_command_line
import os
import sys

def handler(request):
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'seu_projeto.settings')
    
    try:
        execute_from_command_line(['manage.py', 'migrate'])
        return {
            'statusCode': 200,
            'body': 'Migra√ß√µes executadas com sucesso!'
        }
    except Exception as e:
        return {
            'statusCode': 500,
            'body': f'Erro: {str(e)}'
        }
```

Acesse: `https://seu-projeto.vercel.app/api/migrate`

---

## üß™ Parte 4: Testando a Configura√ß√£o

### 4.1 Verificando Conex√£o Local

```bash
# Teste local
python manage.py check --database default
python manage.py migrate
python manage.py runserver
```

### 4.2 Verificando Conex√£o Produ√ß√£o

1. **Acesse seu site**: `https://seu-projeto.vercel.app`
2. **Verifique logs**: No Vercel dashboard > Functions
3. **Teste admin**: `https://seu-projeto.vercel.app/admin`

### 4.3 Criando Superuser em Produ√ß√£o

Crie `api/create_superuser.py`:

```python
from django.contrib.auth.models import User
import os

def handler(request):
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'seu_projeto.settings')
    
    try:
        if not User.objects.filter(username='admin').exists():
            User.objects.create_superuser('admin', 'admin@email.com', 'senha123')
            return {'statusCode': 200, 'body': 'Superuser criado!'}
        else:
            return {'statusCode': 200, 'body': 'Superuser j√° existe!'}
    except Exception as e:
        return {'statusCode': 500, 'body': f'Erro: {str(e)}'}
```

---

## üîß Parte 5: Troubleshooting (Resolu√ß√£o de Problemas)

### Erro: "Application Error"

**Solu√ß√£o**:
1. Verifique os logs no Vercel dashboard
2. Confirme se `DJANGO_SETTINGS_MODULE` est√° correto
3. Verifique se todas vari√°veis de ambiente est√£o definidas

### Erro: "Database Connection Failed" 

**Solu√ß√£o**:
1. Confirme se `DATABASE_URL` est√° correta
2. Verifique se o banco PostgreSQL est√° ativo
3. Teste conex√£o local com as credenciais

### Erro: "Static Files Not Found"

**Solu√ß√£o**:
1. Verifique se `whitenoise` est√° instalado
2. Confirme se `collectstatic` executou no build
3. Verifique configura√ß√µes `STATIC_*` no settings

### Erro: "Table doesn't exist"

**Solu√ß√£o**:
1. Execute migra√ß√µes manualmente
2. Verifique se `migrate` est√° no build script
3. Confirme se models est√£o corretos

---

## üìà Parte 6: Otimiza√ß√µes e Boas Pr√°ticas

### Configura√ß√µes de Performance

```python
# Adicione no settings.py para produ√ß√£o
if not DEBUG:
    # Cache de sess√µes
    SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
    
    # Configura√ß√µes de conex√£o do banco
    DATABASES['default']['OPTIONS'] = {
        'MAX_CONNS': 20,
        'OPTIONS': {
            'MAX_CONNS': 20
        }
    }
    
    # Configura√ß√µes de seguran√ßa
    SECURE_CONTENT_TYPE_NOSNIFF = True
    SECURE_BROWSER_XSS_FILTER = True
    X_FRAME_OPTIONS = 'DENY'
```

### Monitoramento

```python
# Adicione para logs detalhados
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
    'loggers': {
        'django.db.backends': {
            'handlers': ['console'],
            'level': 'INFO',
            'propagate': False,
        },
    },
}
```

---

## ‚úÖ Checklist Final

Antes de considerar conclu√≠do:

- [ ] Projeto Django funciona localmente
- [ ] `requirements.txt` atualizado com todas depend√™ncias
- [ ] `vercel.json` configurado corretamente
- [ ] `build_files.sh` criado e execut√°vel
- [ ] Vari√°veis de ambiente configuradas no Vercel
- [ ] Banco PostgreSQL criado e conectado
- [ ] Migra√ß√µes executadas com sucesso
- [ ] Site acess√≠vel em produ√ß√£o
- [ ] Admin Django funcionando
- [ ] Arquivos est√°ticos carregando

---

## üÜò Precisa de Ajuda?

**Documenta√ß√µes Oficiais**:
- [Django Deployment](https://docs.djangoproject.com/en/stable/howto/deployment/)
- [Vercel Python](https://vercel.com/docs/functions/serverless-functions/runtimes/python)
- [Vercel PostgreSQL](https://vercel.com/docs/storage/vercel-postgres)

**Comunidades**:
- [Django Brasil (Telegram)](https://t.me/djangobrasil)
- [Stack Overflow Django](https://stackoverflow.com/questions/tagged/django)

---

üéâ **Parab√©ns!** Seu projeto Django est√° rodando com PostgreSQL no Vercel!

> **Dica Pro**: Sempre teste localmente antes de fazer deploy, e mantenha backups regulares do seu banco de dados.